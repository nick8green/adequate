services:
  admin:
    command: yarn workspace admin dev
    container_name: adequate-admin
    environment:
      APP_NAME: adequate-admin
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/status']
      interval: 30s
      timeout: 5s
      retries: 3
    image: node:${NODE_VERSION:-24}
    networks:
      - admin
    ports:
      - '3001:3000'
    working_dir: /app
    volumes:
      - .:/app

  app:
    command: yarn workspace app dev
    container_name: adequate-app
    environment:
      APP_NAME: adequate-app
    env_file:
      - .env.local
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/status']
      interval: 15s
      timeout: 5s
      retries: 3
    image: node:${NODE_VERSION:-24}
    networks:
      - app
    ports:
      - '3000:3000'
    working_dir: /app
    volumes:
      - .:/app
      - ./development/app/images:/app/apps/app/public/assets/images

  content:
    command: yarn workspace content-service dev
    container_name: adequate-content
    environment:
      APP_NAME: adequate-content
      DOMAIN: http://localhost:3000,http://localhost:3002,https://studio.apollographql.com
      DB_HOST: adequate-db
      DB_NAME: content
      DB_USER: content-service-migrate # ONLY FOR DEV
      DB_PASSWORD: migrate # ONLY FOR DEV
      DB_READER_USER: content-service-read
      DB_READER_PASSWORD: reader
      DB_WRITER_USER: content-service-write
      DB_WRITER_PASSWORD: writer
      DB_MIGRATIONS: /app/migrations
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/status']
      interval: 15s
      timeout: 5s
      retries: 5
    image: node:${NODE_VERSION:-24}
    networks:
      - service
    ports:
      - '3002:3000'
    working_dir: /app
    volumes:
      - .:/app

  db:
    container_name: adequate-db
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-overrideme}
    env_file:
      - .env.local
    image: mysql:${MYSQL_VERSION:-9.4.0}
    networks:
      - service
    volumes:
      - ./scripts/dev.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - mysql-data:/var/lib/mysql

  docs:
    command: yarn workspace docs start --host 0.0.0.0 --no-open --poll 2000
    container_name: adequate-docs
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/status']
      interval: 30s
      timeout: 5s
      retries: 5
    image: node:${NODE_VERSION:-24}
    ports:
      - '3030:3000'
    working_dir: /app
    volumes:
      - .:/app

  gateway:
    command: yarn workspace gateway dev
    container_name: adequate-gateway
    depends_on:
      content:
        condition: service_healthy
    environment:
      APP_NAME: adequate-gateway
      DOMAIN: http://localhost:3000,https://studio.apollographql.com
      SUBGRAPHS_CONFIG: /config/subgraphs.json
    healthcheck:
      test:
        [
          'CMD',
          'curl',
          '-f',
          '--header "origin: http://healthcheck"',
          'http://localhost:4000/status',
        ]
      interval: 15s
      timeout: 5s
      retries: 5
    image: node:${NODE_VERSION:-24}
    networks:
      - app
      - service
    ports:
      - '4000:4000'
    working_dir: /app
    volumes:
      - .:/app
      - ./development/service/subgraphs.json:/config/subgraphs.json

  grafana:
    container_name: adequate-grafana
    depends_on:
      - prometheus
    image: grafana/grafana-enterprise:${GRAFANA_VERSION}
    networks:
      - monitoring
    ports:
      - '8080:3000'
    volumes:
      - grafana-storage:/var/lib/grafana
      - ./development/grafana/alerts/:/etc/grafana/alerts/
      - ./development/grafana/dashboards/:/etc/grafana/dashboards/
      - ./development/grafana/provisioning/:/etc/grafana/provisioning/
      - ./development/grafana/grafana.ini:/etc/grafana/grafana.ini

  prometheus:
    command: --config.file=/etc/prometheus/prometheus.yml
    container_name: adequate-prometheus
    depends_on:
      - app
    image: prom/prometheus:${PROMETHEUS_VERSION}
    networks:
      - app
      - admin
      - monitoring
    ports:
      - '9090:9090'
    volumes:
      - ./development/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml

  pushgateway:
    container_name: adequate-pushgateway
    image: prom/pushgateway:${PROMETHEUS_PUSHGATEWAY_VERSION}
    networks:
      - monitoring
    ports:
      - '9091:9091'

networks:
  admin:
    name: adequate-admin
  app:
    name: adequate-dev
  monitoring:
    name: adequate-monitoring
  service:
    name: adequate-federation

volumes:
  grafana-storage:
    name: adequate-grafana-storage
  mysql-data:
    name: adequate-data
